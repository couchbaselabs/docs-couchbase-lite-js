= Databases
:page-aliases:
:page-role:
:description: Working with Couchbase Lite Databases in JavaScript

:source-language: JavaScript

[abstract]
--
Description -- _{description}_ +
Related Content -- xref:encryption.adoc[Encryption] | xref:blob.adoc[Blobs] | xref:document.adoc[Documents] | xref:indexing.adoc[Indexing]
--

[#database-concepts]
== Database Concepts

Databases created on Couchbase Lite can share the same hierarchical structure as Capella databases.
This makes it easier to sync data between browser applications and applications built using Capella.

.Couchbase Lite Database Hierarchy
[plantuml]
----
@startuml

database "Database" as db

rectangle "Scope" as scope

folder "Collection" as collection

file "Document" as document1
file "Document" as document2
file "Document" as document3

db --> scope
scope --> collection
collection --> document1
collection --> document2
collection --> document3

note right of collection
  Maximum of 1000 per scope
end note

note right of db
  One database per application
end note

@enduml
----

Although the terminology is different, the structure can be mapped to relational database terms:

.Relational Database -> Couchbase
[width=70%,grid=none]
|===
|Relational database |Couchbase

|Database
|Database

|Schema
|Scope

|Table
|Collection
|===

This structure gives you plenty of choices when it comes to partitioning your data.
The most basic structure is to use the single default scope with a single default collection; or you could opt for a structure that allows you to split your collections into logical scopes.

[#cbl-database-structure]
.Couchbase Lite Examples

[plantuml#cbl-database-structure]
----
@startuml

database "Couchbase Lite database" as db1 {
      node "_default scope" as dfs1 {
        folder "_default collection" as dfc1 {
        }
      }
}

database "Couchbase Lite database" as db2 {
    node "_default scope" as dfs2 {
      folder "_default collection" as dfc2 {
      }
        folder "Collection A" as collectionA {
        }
    }
    node "Scope A" as scopeA {
      folder "Collection A" as collectionA2 {
      }
        folder "Collection B" as collectionB {
        }
    }
}

collectionA2 -D[hidden]-> collectionB
collectionA -D[hidden]-> dfc2
@enduml
----

.Storing local configuration
****
You may not need to sync all the data related for a particular application. You can set up a scope that syncs data, and a second scope that doesn't.

One reason for doing this is to store local configuration data (such as user preferences or UI state). Since this information only relates to a particular browser or device, there is no need to sync it:

[horizontal]
local data scope:: Contains information pertaining to the browser or device.

syncing data scope:: Contains information pertaining to the user, which can be synced back to the cloud for use on the web or another device.

****

[#browser-storage]
== Browser Storage

Couchbase Lite JavaScript stores data in the browser's IndexedDB, a robust client-side storage API.

.IndexedDB Characteristics
* Stores data persistently across browser sessions
* Subject to browser storage quotas
* Data is scoped per origin (protocol + domain + port)
* Supports concurrent access from multiple browser tabs
* May be evicted under storage pressure on some browsers

[#open-db]
== Create or Open Database

You can create a new database and-or open an existing database, using the https://docs.couchbase.com/mobile/{version-maintenance}/couchbase-lite-javascript/classes/Database.html[Database] class.
Pass in a database name and a https://docs.couchbase.com/mobile/{version-maintenance}/couchbase-lite-javascript/interfaces/DatabaseConfig.html[DatabaseConfig] -- see xref:database.adoc#ex-dbopen[].

Things to watch for include:

* If the named database does not exist, a new one is created
* The database is stored in the browser's IndexedDB under the current origin

IMPORTANT: Unlike native Couchbase Lite SDKs, collections and their indexes must be declared in the `DatabaseConfig` when opening the database. Collections cannot be created or deleted while the database is open.

[#ex-dbopen]
.Open or create a database

[#ex-dbopen]
====

[source,javascript]
----
include::example$code_snippets/code_snippets.ts[tags="open-database", indent=0]
----

<.> Database configuration with name and version
<.> Collections configuration (required)
<.> Open the database
====

[#database-configuration]
== Database Configuration

The https://docs.couchbase.com/mobile/{version-maintenance}/couchbase-lite-javascript/interfaces/DatabaseConfig.html[DatabaseConfig] interface provides options for configuring your database:

[cols="1,1,3"]
|===
|Property |Type |Description

|`collections`
|CollectionsConfig
|Declares all collections and their configurations. Required.

|`password`
|string
|Encryption password for database encryption at rest. See xref:encryption.adoc[Database Encryption]. Optional.

|===

.Collections Configuration

Each collection can have its own configuration within the `collections` object:

[cols="1,1,3"]
|===
|Property |Type |Description

|`indexes`
|string[]
|Index properties for the collection. Indexed properties are not encrypted when database encryption is enabled. See xref:indexing.adoc[Indexing] and xref:encryption.adoc[Database Encryption]. Optional.

|===

[#ex-dbconfig]
.Configure database with encryption

[#ex-dbconfig]
====

[source,javascript]
----
include::example$code_snippets/code_snippets.ts[tags="open-database-encrypted", indent=0]
----

<.> Database name and version
<.> Encryption password
<.> Unencrypted properties (can be indexed)
====

[#close-database]
== Close Database

You are advised to incorporate the closing of all open databases into your application workflow.

To close a database, use https://docs.couchbase.com/mobile/{version-maintenance}/couchbase-lite-javascript/classes/Database.html#close[Database.close()] -- see: xref:database.adoc#ex-dbclose[].
This also closes active replications, listeners and-or live queries connected to the database.

NOTE: Closing a database soon after starting a replication involving it can cause an exception as the asynchronous replicator may not yet be connected.

.Safely Closing a Database
TIP: Before closing, check that any attached listeners (query/replication/change) indicate they are at least at `connected` status before closing -- see for example: xref:replication.adoc#lbl-repl-mon[Monitor Status].

.Close a Database
[#ex-dbclose]

[#ex-dbclose]
====

[source,javascript]
----
include::example$code_snippets/code_snippets.ts[tags="close-database", indent=0]
----

====

[#reopen-database]
== Reopen Database

After closing a database, you can reopen it using the same configuration.
If the database was encrypted, you must provide the password when reopening the database -- see xref:encryption.adoc[Database Encryption] for more information.

[#database-encryption]
== Database Encryption

Couchbase Lite JavaScript supports encrypting databases stored in IndexedDB to secure data at rest.

For complete information on database encryption, including how to enable encryption, manage encryption keys, and understand encryption limitations in browser environments, see xref:encryption.adoc[Database Encryption].


[#delete-database]
== Delete Database

To permanently delete a database and all its data from IndexedDB:

[#ex-delete-db]
.Delete a database

[#ex-delete-db]
====

[source,javascript]
----
// Close the database first
await database.close();

// Delete the database
await Database.delete('myapp');

console.log('Database deleted');
----

====

WARNING: Deleting a database is permanent and cannot be undone. All data, collections, and indexes are removed from IndexedDB.

[#multiple-databases]
== Multiple Databases

An application can open and use multiple databases simultaneously.
Each database is stored separately in IndexedDB.

[#ex-multiple-dbs]
.Using multiple databases

[#ex-multiple-dbs]
====

[source,javascript]
----
// Open multiple databases
const userDb = await Database.open('users', {
  collections: { profiles: {} }
});

const contentDb = await Database.open('content', {
  collections: { articles: {}, comments: {} }
});

const localDb = await Database.open('local-config', {
  collections: { settings: {} }
});

// Use them independently
await userDb.collection.profiles.save({...});
await contentDb.collection.articles.save({...});

// Close when done
await userDb.close();
await contentDb.close();
await localDb.close();
----

====

[#storage-management]
== Storage Management

Databases in Couchbase Lite JavaScript are subject to browser storage quotas and policies.

IMPORTANT: IndexedDB quotas, persistence, and eviction rules vary by browser, so the same app may store different amounts of data across environments. When writes exceed quota, a `QuotaExceededError` is thrown with no automatic retry or cleanup. The application must catch these errors, decide how to free space, or prompt the user. The SDK relies entirely on IndexedDB's native behavior. See xref:supported-browsers.adoc#browser-specific-considerations[Browsers and Storage] for detailed information.


[#storage-quotas]
=== Storage Quotas

Browsers enforce storage quotas that vary by platform:

* Desktop browsers: Typically 10% of available disk space
* Mobile browsers: Typically 50-100 MB
* Private browsing: Limited or no persistent storage

For detailed storage limits by browser, see xref:supported-browsers.adoc#browser-specific-considerations[Browser-Specific Considerations].

The SDK provides APIs to check available storage:

[#ex-check-storage]
.Check storage quota

[#ex-check-storage]
====

[source,javascript]
----
if (navigator.storage && navigator.storage.estimate) {
  const estimate = await navigator.storage.estimate();

  console.log('Quota:', estimate.quota);
  console.log('Usage:', estimate.usage);
  console.log('Available:', estimate.quota - estimate.usage);

  const percentUsed = (estimate.usage / estimate.quota) * 100;
  console.log(`Storage: ${percentUsed.toFixed(2)}% used`);
}
----

====

[#persistent-storage]
=== Request Persistent Storage

To reduce the risk of storage eviction, request persistent storage:

[#ex-persistent-storage]
.Request persistent storage

[#ex-persistent-storage]
====

[source,javascript]
----
if (navigator.storage && navigator.storage.persist) {
  const isPersistent = await navigator.storage.persist();

  if (isPersistent) {
    console.log('Persistent storage granted');
  } else {
    console.log('Persistent storage not granted');
  }
}
----

====


[#database-maintenance]
== Database Maintenance

From time to time it may be necessary to perform maintenance on your database, such as compacting the database to remove unused documents and blobs.

Couchbase Lite's API provides the https://docs.couchbase.com/mobile/{version-maintenance}/couchbase-lite-javascript/classes/Database.html#performMaintenance[Database.performMaintenance()] method.
The available maintenance operations include `compact`, `reindex`, and `integrityCheck`.

This is a resource-intensive operation and is not performed automatically.
It should be run on-demand using the API.

[#ex-compact-db]
.Compact a database

[#ex-compact-db]
====

[source,javascript]
----
// Compact the database to reclaim space
await database.performMaintenance('compact');

console.log('Database compacted');
----

====

[#inspect-database]
== Inspect Database

You can inspect the contents of your database using browser developer tools.

[#using-devtools]
=== Using Browser DevTools

To view your database in IndexedDB:

1. Open browser DevTools (F12 or Cmd/Ctrl+Shift+I)
2. Go to the *Application* tab (Chrome) or *Storage* tab (Firefox)
3. Expand *IndexedDB* in the sidebar
4. Find your database by name
5. Explore collections and documents

.Browser DevTools
****
* **Chrome DevTools**: Application > Storage > IndexedDB
* **Firefox DevTools**: Storage > IndexedDB
* **Safari DevTools**: Storage > IndexedDB (Enable Develop menu first)
* **Edge DevTools**: Application > Storage > IndexedDB
****

[#change-listeners]
== Change Listeners

IndexedDB allows concurrent reading from multiple tabs. Write operations are serialized per store/transaction, not per tab. IndexedDB does not have built-in cross-tab change notifications; these must be implemented by the SDK or the app.

The SDK provides two types of change listeners, depending on the granularity your application needs:

[#collection-change-listeners]
=== Collection Change Listeners

* Trigger whenever any document in the collection changes
* Useful for keeping UI or state synchronized broadly

[#ex-collection-listener]
.Collection Change Listener Example

[#ex-collection-listener]
====

[source,javascript]
----
const collection = database.collection.tasks;

// Fires when any document in the collection changes
const token = collection.addChangeListener((changes) => {
  console.log("Changed docs:", changes.documentIDs);
  refreshUI();
});

// Remove listener when done
collection.removeChangeListener(token);
----

====

[#document-change-listeners]
=== Document Change Listeners

* Trigger only when a specific document changes
* Useful when you want focused updates without scanning the whole collection

[#ex-document-listener]
.Document Change Listener Example

[#ex-document-listener]
====

[source,javascript]
----
const collection = database.collection.tasks;
const docId = "task_001";

// Fires only when the given document changes
const token = collection.addDocumentChangeListener(docId, (change) => {
  console.log("Document updated:", change.documentID);
  updateTaskView(docId);
});

// Remove listener when done
collection.removeDocumentChangeListener(token);
----

====

[#troubleshooting]
== Troubleshooting

You should use browser console logs as your first source of diagnostic information.
If the information in the default logging level is insufficient, you can focus it on database errors and generate more verbose messages -- see: xref:database.adoc#ex-logdb[].

For more on using Couchbase logs -- see: xref:logging.adoc[Using Logs].

[#ex-logdb]
.Increase level of database log messages

[#ex-logdb]
====

[source,javascript]
----
import { configure, getConsoleSink } from '@logtape/logtape';
import { LogCategory } from '@couchbase/lite-js';

// Configure logging for database operations
await configure({
  sinks: {
    console: getConsoleSink(),
  },
  loggers: [
    {
      category: [LogCategory, 'DB'],
      lowestLevel: 'debug',
      sinks: ['console'],
    }
  ],
});
----

====

[#common-issues]
=== Common Issues

[#quota-exceeded]
==== QuotaExceededError

**Problem:** Database operations fail with `QuotaExceededError`

**Solutions:**

* Request persistent storage
* Reduce data size
* Compact the database
* Delete unnecessary documents

See xref:troubleshooting-storage.adoc[] for more solutions.

[#incorrect-password]
==== EncryptionError

**Problem:** Database fails to open with encryption error

**Solutions:**

* Verify the encryption password is correct
* Check if database was encrypted in the first place
* Ensure password is consistently provided

[#collections-not-accessible]
==== Collections Not Accessible

**Problem:** Cannot access collections after opening database

**Solutions:**

* Verify collections were declared in `DatabaseConfig`
* Close and reopen database with correct configuration
* Check collection names for typos

[#related-content]
== Related Content
++++
<div class="card-row three-column-row">
++++

[.column]
====== {empty}
.How to . . .
* xref:gs-prereqs.adoc[Prerequisites]
* xref:gs-install.adoc[Install]

.

[.column]
====== {empty}
.Learn more . . .
* xref:database.adoc[Databases]
* xref:document.adoc[Documents]
* xref:blob.adoc[Blobs]
* xref:replication.adoc[Remote Sync Gateway]
* xref:conflict.adoc[Handling Data Conflicts]

.

[.column]
====== {empty}
.Dive Deeper . . .
https://forums.couchbase.com/c/mobile/14[Mobile Forum] |
https://blog.couchbase.com/[Blog] |
https://docs.couchbase.com/tutorials/[Tutorials]

.

++++
</div>
++++