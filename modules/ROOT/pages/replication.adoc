= Data Sync using Sync Gateway
:page-aliases:
:page-role:
:description: Couchbase Lite JavaScript -- Synchronizing data changes between local and remote databases using Sync Gateway

:source-language: javascript

[abstract]
--
Description -- _{description}_ +
Related Content -- xref:conflict.adoc[Handling Data Conflicts]
--

.Code Snippets
[NOTE]
All code examples are indicative only.
They demonstrate the basic concepts and approaches to using a feature.
Use them as inspiration and adapt these examples to best practice when developing applications for your platform.

[#introduction]
== Introduction

Couchbase Lite JavaScript provides API support for secure, bi-directional, synchronization of data changes between browser applications and a central server database.
It does so by using a _replicator_ to interact with Sync Gateway.

The _replicator_ is designed to manage replication of documents and document changes between a source and a target database.
For example, between a local Couchbase Lite database in the browser and a remote Sync Gateway database, which is ultimately mapped to a bucket in a Couchbase Server instance in the cloud or on a server.

This page shows sample code and configuration examples covering the implementation of a replication using Sync Gateway.

Your application runs a replicator (also referred to here as a client), which will initiate connection with a Sync Gateway (also referred to here as a server) and participate in the replication of database changes to bring both local and remote databases into sync.

[#replication-concepts]
== Replication Concepts

Couchbase Lite allows for one database for each application running in the browser.
This database can contain one or more scopes.
Each scope can contain one or more collections.

To learn about Scopes and Collections, see xref:database.adoc[]

You can set up a replication scheme across these data levels:

Database:: The `_default` collection is synced.

Collection:: A specific collection or a set of collections is synced.

As part of the syncing setup, the Gateway has to map the Couchbase Lite database to the database being synced on Capella.

[#replication-protocol]
== Replication Protocol

[#scheme]
=== Scheme

Couchbase Lite JavaScript uses a WebSocket-based replication protocol.
The replication URL must specify WebSockets as the URL scheme using `ws://` (non-TLS) or `wss://` (SSL/TLS) prefixes.

IMPORTANT: Always use `wss://` (WebSocket Secure) in production for encrypted communication with Sync Gateway.

Incompatibilities::
Couchbase Lite's replication protocol is *incompatible* with CouchDB-based databases and PouchDB's replication protocol.

[#lbl-repl-ord]
=== Ordering

To optimize for speed, the replication protocol doesn't guarantee that documents will be received in a particular order.
We don't recommend relying on document order when using replication or database change listeners.

[#scopes-and-collections]
== Scopes and Collections

Scopes and Collections allow you to organize your documents in Couchbase Lite.

When syncing, you can configure the collections to be synced.

The collections specified in the Couchbase Lite replicator setup must exist (both scope and collection name must be identical) on the Sync Gateway side, otherwise starting the Couchbase Lite replicator will result in an error.

During replication:

. If Sync Gateway config (or server) is updated to remove a collection that is being synced, the client replicator will be offline and will be stopped after the first retry. An error will be reported.

. If Sync Gateway config is updated to add a collection to a scope that is being synchronized, the replication will ignore the collection. The added collection will not automatically sync until the Couchbase Lite replicator's configuration is updated.

[#default-collection]
=== Default Collection

When you set up the replicator with the database, the default collection will be set up to sync with the default collection on Sync Gateway.

[#user-defined-collections]
=== User-Defined Collections

The user-defined collections specified in the Couchbase Lite replicator setup must exist (and be identical) on the Sync Gateway side to sync.

[#configuration-summary]
== Configuration Summary

You should configure and initialize a replicator for each Couchbase Lite database instance you want to sync.
The following example shows the configuration and initialization process.

NOTE: You need Couchbase Lite 3.1+ and Sync Gateway 3.1+ to use `custom` Scopes and Collections. +
If you're using Capella App Services or Sync Gateway releases that are older than version 3.1, you won't be able to access `custom` Scopes and Collections.

.Replication configuration and initialization
[#ex-simple-repl]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="simple-replication", indent=0]
----

====

*Notes on Example*

<.> Configure the replicator with database and target URL
<.> Configure collections to replicate
<.> Set up authentication credentials
<.> Set replication to continuous mode
<.> Configure conflict resolver (optional)
<.> Create the replicator instance
<.> Add status change listener
<.> Start the replicator

[#lbl-cfg-repl]
== Configure

In this section::
+
--
xref:replication.adoc#lbl-cfg-tgt[]
|  xref:replication.adoc#lbl-cfg-sync[]
|  xref:replication.adoc#lbl-user-auth[]
|  xref:replication.adoc#lbl-repl-hdrs[]
|  xref:replication.adoc#lbl-repl-fltrs[]
|  xref:replication.adoc#lbl-repl-delta[]
--

[#lbl-cfg-tgt]
=== Configure Target

Initialize and define the replication configuration with local and remote database locations using the `ReplicatorConfig` object.

The configuration provides:

* The local database to be synced
* The server's URL (including the port number and the name of the remote database to sync with)
* The URL scheme for WebSocket URLs uses `ws:` (non-TLS) or `wss:` (SSL/TLS) prefixes

.Add Target to Configuration
[#ex-cfg-target]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="config-target", indent=0]
----

====

<.> Use `wss://` to ensure TLS encryption (strongly recommended in production)

[#lbl-cfg-sync]
=== Sync Mode

Define the direction and type of replication you want to initiate.

Use the `ReplicatorConfig` object's `replicatorType` and `continuous` parameters to specify:

* The type (or direction) of the replication:
** `pushAndPull` - Bi-directional replication (default)
** `pull` - Pull-only replication
** `push` - Push-only replication

* The replication mode:
** *Continuous* - remaining active indefinitely to replicate changed documents (`continuous: true`)
** *Ad-hoc* - a one-shot replication of changed documents (`continuous: false`)

.Configure replicator type and mode
[#ex-repl-sync]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="config-sync-mode", indent=0]
----

====

[TIP]
--
Unless there is a solid use-case not to, always initiate a single `pushAndPull` replication rather than separate `push` and `pull` replications.

This prevents the replications generating the same checkpoint resulting in conflicts.
--

[#lbl-user-auth]
=== User Authorization

By default, Sync Gateway does not enable user authorization.
This makes it easier to get up and running with synchronization.

You can enable authorization in the Sync Gateway configuration file.

To authorize with Sync Gateway, an associated user must first be created.
Sync Gateway users can be created through the Admin REST API.

[#lbl-client-auth]
=== Client Authentication

[#basic-authentication]
==== Basic Authentication

IMPORTANT: Due to browser security restrictions, Couchbase Lite JavaScript handles authentication differently than native platforms.

The replicator uses a two-step authentication process:

1. Posts credentials to Sync Gateway's `/_session` endpoint to establish a login session
2. Uses the returned session cookie for all subsequent WebSocket requests

For this to work, Sync Gateway's CORS settings must be configured properly:

.Sync Gateway CORS Configuration
====
[source,json]
----
{
  "databases": {
    "mydb": {
      "cors": {
        "origin": ["https://mywebsite.com"],
        "login_origin": ["https://mywebsite.com"],
        "headers": ["Authorization"],
        "max_age": 86400
      }
    }
  }
}
----
====

The `origin` must explicitly list your website's origin, and `Authorization` must be in the allowed headers list.

.Basic Authentication
[#ex-base-auth]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="basic-authentication", indent=0]
----

====

[#session-authentication]
==== Session Authentication

Session authentication is another way to authenticate with Sync Gateway.

A user session must first be created through the `POST /{db}/_session` endpoint on the Public REST API.

The HTTP response contains a session ID which can then be used to authenticate as the user it was created for.

.Session Authentication
[#ex-session-auth]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="session-authentication", indent=0]
----

====

[#lbl-repl-hdrs]
=== Custom Headers

Custom headers can be set on the configuration object.
The replicator will then include those headers in every request.

This feature is useful for passing additional credentials, perhaps when an authentication or authorization step is being done by a proxy server (between Couchbase Lite and Sync Gateway).

.Setting custom headers
[#ex-cust-hdr]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="custom-headers", indent=0]
----

====

[#lbl-repl-fltrs]
=== Replication Filters

Replication Filters allow you to have control over the documents stored as the result of a push and/or pull replication.

[#push-filter]
==== Push Filter

The push filter allows an app to push a subset of a database to the server.

.Push Filter
[#ex-push-filter]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="push-filter", indent=0]
----

====

<.> The callback should follow the semantics of a pure function.
Long running functions would slow down the replicator considerably.

[#pull-filter]
==== Pull Filter

The pull filter gives an app the ability to validate documents being pulled, and skip ones that fail.

NOTE: Pull replication filters are not a substitute for channels.
Sync Gateway channels are designed to be scalable (documents are filtered on the server) whereas a pull replication filter is applied to a document once it has been downloaded.

.Pull Filter
[#ex-pull-filter]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="pull-filter", indent=0]
----

====

[#lbl-repl-delta]
=== Delta Sync

IMPORTANT: This is an https://www.couchbase.com/products/editions[Enterprise Edition] feature.

With Delta Sync, only the changed parts of a Couchbase document are replicated.
This can result in significant savings in bandwidth consumption as well as throughput improvements, especially when network bandwidth is typically constrained.

Replications to Sync Gateway automatically use delta sync if the property is enabled at database level by the server.

.Configure Delta Sync
[#ex-delta-sync]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="delta-sync", indent=0]
----

====

[#lbl-init-repl]
== Initialize

[#lbl-repl-start]
=== Start Replicator

Use the `Replicator` class constructor to initialize the replicator with the configuration you have defined.
You can optionally add change listeners before starting the replicator using `start()`.

.Initialize and run replicator
[#ex-start-repl]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="start-replicator", indent=0]
----

====

<.> Create the replicator with the configuration
<.> Start the replicator

[#lbl-repl-ckpt]
=== Checkpoint Starts

Replicators use checkpoints to keep track of documents sent to the target database.

Without checkpoints, Couchbase Lite would replicate the entire database content to the target database on each connection.

If you want to force the replication to start again from zero, use the checkpoint reset when starting the replicator.

.Resetting checkpoints
[#ex-repl-ckpt]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="reset-checkpoint", indent=0]
----

====

[#lbl-repl-mon]
== Monitor

In this section::
xref:replication.adoc#lbl-repl-chng[]  |
xref:replication.adoc#lbl-repl-status[]  |
xref:replication.adoc#lbl-repl-evnts[] |
xref:replication.adoc#lbl-repl-pend[]

You can monitor a replication's status by using change listeners and the `replicator.status` property.
This enables you to know when the replication is actively transferring data and when it has stopped.

[#lbl-repl-chng]
=== Change Listeners

Use change listeners to monitor replication progress.
You can add a replicator change listener at any point; it will report changes from the point it is registered.

.Best Practice
TIP: Remove listeners when they're no longer needed to prevent memory leaks

.Monitor replication
[#ex-repl-mon]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="replication-status", indent=0]
----

====

[#lbl-repl-status]
=== Replicator Status

You can check the replicator status using the `status` property.
The status indicates whether the replicator is actively transferring data or if it has stopped.

The returned status structure comprises:

* `activity` - stopped, offline, connecting, idle or busy
* `progress`
** `completed` - the total number of changes completed
** `total` - the total number of changes to be processed
* `error` - the current error, if any

[#lbl-repl-states]
==== Replication States

.Replicator activity levels
[#tbl-states,cols="^1,4"]
|===
h|State
h|Meaning

|`STOPPED`
|The replication is finished or hit a fatal error.

|`OFFLINE`
|The replicator is offline as the remote host is unreachable.

|`CONNECTING`
|The replicator is connecting to the remote host.

|`IDLE`
|The replication caught up with all the changes available from the server.
The `IDLE` state is only used in continuous replications.

|`BUSY`
|The replication is actively transferring data.
|===

[#lbl-repl-evnts]
=== Monitor Document Changes

You can register listeners to monitor document replication.

.Register a document listener
[#ex-reg-doc-listener]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="document-replication-listener", indent=0]
----

====

[#document-access-removal-behavior]
==== Document Access Removal Behavior

When access to a document is removed on Sync Gateway, the document replication listener receives a notification and the document is purged from the local database.

[#lbl-repl-pend]
=== Documents Pending Push

You can check whether documents are waiting to be pushed in any forthcoming sync.

.Check pending documents
[#ex-pending]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="pending-documents", indent=0]
----

====

[#lbl-repl-stop]
== Stop

Stopping a replication is straightforward using `stop()`.
This initiates an asynchronous operation and so is not necessarily immediate.

.Stop replicator
[#ex-stop-repl]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="stop-replicator", indent=0]
----

====

[#lbl-nwk-errs]
== Error Handling

When the replicator detects a network error it updates its status depending on the error type (permanent or temporary) and returns an appropriate error code.

.Monitoring for network errors
[#ex-error-handling]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="error-handling", indent=0]
----

====

*For permanent network errors* (for example, `404` not found, or `401` unauthorized):
The replicator will stop permanently. It sets its status to `STOPPED`.

*For recoverable or temporary errors:* The replicator sets its status to `OFFLINE`, then:

* If `continuous=true` it retries the connection indefinitely
* If `continuous=false` (one-shot) it retries the connection a limited number of times

The following error codes are considered temporary and will trigger a connection retry:

* `408`: Request Timeout
* `429`: Too Many Requests
* `500`: Internal Server Error
* `502`: Bad Gateway
* `503`: Service Unavailable
* `504`: Gateway Timeout
* `1001`: DNS resolution error

[#browser-specific]
== Browser-Specific Considerations

[#connection-lifecycle]
=== Connection Lifecycle

Browser applications have unique lifecycle considerations:

**Page Visibility:**

* When a browser tab becomes hidden, browsers may throttle or suspend JavaScript execution
* Continuous replications may pause when the tab is not visible
* Consider stopping replications when the page is hidden and restarting when visible

**Connection Persistence:**

* WebSocket connections may be closed by the browser when a tab is inactive
* Mobile browsers are particularly aggressive about closing connections
* Monitor connection status and reconnect when the page becomes visible again

.Handle page visibility
[#ex-visibility]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="page-visibility", indent=0]
----

====

[#service-workers]
=== Service Workers

For background synchronization in Progressive Web Apps (PWAs), consider using Service Workers:

* Service Workers can run in the background even when the page is closed
* They can perform sync operations when connectivity is restored
* Useful for ensuring data is synced even if the user closes the browser

[#cors-requirements]
=== CORS Requirements

Browser security requires proper CORS configuration on Sync Gateway:

**Minimum CORS Settings:**

[source,json]
----
{
  "cors": {
    "origin": ["https://your-domain.com"],
    "login_origin": ["https://your-domain.com"],
    "headers": ["Authorization", "Content-Type"],
    "max_age": 86400
  }
}
----

* `origin` must explicitly list your website's origin (wildcards not recommended for production)
* `login_origin` required for authentication to work
* `Authorization` header must be allowed

[#lbl-trouble]
== Troubleshooting

[#logs]
=== Logs

When there is a problem with replication, logging is your friend.
You can increase the log output for activity related to replication with Sync Gateway.

.Set logging verbosity
[#ex-logs]

====

[source, javascript]
----
include::example$code_snippets/code_snippets.js[tags="replication-logging", indent=0]
----

====

For more on troubleshooting with logs, see: xref:troubleshooting-logs.adoc[].

[#authentication-errors]
=== Authentication Errors

Common authentication issues:

**CORS Configuration:**
If CORS is not properly configured, you'll see errors like "Network request failed" or CORS policy errors in the browser console.

**Protocol Mismatch:**
If Sync Gateway expects HTTPS/WSS but your app uses HTTP/WS, you'll encounter connection errors.

**Session Cookie Issues:**
Session cookies require proper domain and path settings. Check browser DevTools Network tab to verify cookies are being sent.

[#connection-issues]
=== Connection Issues

**WebSocket Connection Failed:**

* Verify Sync Gateway is running and accessible
* Check firewall rules allow WebSocket connections
* Ensure the URL scheme matches (ws:// vs wss://)
* Verify CORS settings on Sync Gateway

**Frequent Disconnections:**

* Check network stability
* Monitor browser console for errors
* Verify Sync Gateway load balancer configuration supports WebSockets
* Consider implementing reconnection logic

[#related-content]
== Related Content
++++
<div class="card-row three-column-row">
++++

[.column]
=== {empty}
.How to . . .
* xref:gs-prereqs.adoc[Prerequisites]
* xref:gs-install.adoc[Install]

.

[.column]
=== {empty}
.Learn more . . .
* xref:database.adoc[Databases]
* xref:document.adoc[Documents]
* xref:blob.adoc[Blobs]
* xref:replication.adoc[Remote Sync Gateway]
* xref:conflict.adoc[Handling Data Conflicts]

.

[.column]
=== {empty}
.Dive Deeper . . .
https://forums.couchbase.com/c/mobile/14[Mobile Forum] |
https://blog.couchbase.com/[Blog] |
https://docs.couchbase.com/tutorials/[Tutorials]

.

++++
</div>
++++